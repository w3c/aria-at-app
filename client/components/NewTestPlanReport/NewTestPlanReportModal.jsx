import React, { useState, useEffect } from 'react';
import { Button, Modal, Form } from 'react-bootstrap';
import PropTypes from 'prop-types';
import { useQuery, useMutation } from '@apollo/client';
import {
    ADD_TEST_QUEUE_MUTATION,
    POPULATE_ADD_TEST_PLAN_TO_QUEUE_MODAL_QUERY
} from '../TestQueue/queries';
import { gitUpdatedDateToString } from '../../utils/gitUtils';

const NewTestPlanReportModal = ({
    show = false,
    handleClose = () => {},
    handleAddToTestQueue = () => {}
}) => {
    const [ats, setAts] = useState([]);
    const [browsers, setBrowsers] = useState([]);
    const [allTestPlanVersions, setAllTestPlanVersions] = useState([]);
    const [filteredTestPlanVersions, setFilteredTestPlanVersions] = useState(
        []
    );
    const [testPlanVersions, setTestPlanVersions] = useState([]);
    const [selectedAt, setSelectedAt] = useState('');
    const [selectedBrowser, setSelectedBrowser] = useState('');
    const [atVersion, setAtVersion] = useState('');
    const [browserVersion, setBrowserVersion] = useState('');
    const [selectedTestPlan, setSelectedTestPlan] = useState('');
    const [selectedTestPlanVersion, setSelectedTestPlanVersion] = useState('');

    // eslint-disable-next-line no-unused-vars
    const { loading, error, data } = useQuery(
        POPULATE_ADD_TEST_PLAN_TO_QUEUE_MODAL_QUERY
    );
    const [addTestPlanReport] = useMutation(ADD_TEST_QUEUE_MUTATION);

    useEffect(() => {
        if (data) {
            const { ats = [], browsers = [], testPlanVersions = [] } = data;
            setAts(ats);
            setBrowsers(browsers);

            const allTestPlanVersions = testPlanVersions
                .map(version => ({
                    ...version
                }))
                .flat();
            setAllTestPlanVersions(allTestPlanVersions);
        }
    }, [data]);

    useEffect(() => {
        const filteredTestPlanVersions = allTestPlanVersions.filter(
            (v, i, a) =>
                a.findIndex(
                    t =>
                        t.title === v.title &&
                        t.testPlan.directory === v.testPlan.directory
                ) === i
        );
        setFilteredTestPlanVersions(filteredTestPlanVersions);
    }, [allTestPlanVersions]);

    const handleCreateTestPlanReport = async () => {
        await addTestPlanReport({
            variables: {
                testPlanVersionId: selectedTestPlanVersion,
                atId: selectedAt,
                atVersion: atVersion,
                browserId: selectedBrowser,
                browserVersion: browserVersion
            }
        });
        await handleAddToTestQueue();
    };

    const dropdownRowWithInputField = ({
        controlId,
        label,
        dropdownOptions,
        dropdownPlaceholder,
        inputFieldPlaceholder,
        dropdownValue,
        inputFieldValue,
        handleDropdownSelected,
        handleInputFieldUpdated
    }) => {
        return (
            <div className="add-test-plan-queue-modal-row">
                <Form.Group controlId={controlId}>
                    <Form.Label>{label}</Form.Label>
                    <Form.Control
                        as="select"
                        onChange={e => handleDropdownSelected(e.target.value)}
                        value={dropdownValue}
                    >
                        <option disabled value={''}>
                            {dropdownPlaceholder}
                        </option>
                        {dropdownOptions.map(item => (
                            <option
                                key={`${item.name}-${item.id}`}
                                value={item.id}
                            >
                                {item.name}
                            </option>
                        ))}
                    </Form.Control>
                </Form.Group>
                <Form.Group className="add-test-plan-queue-modal-normalize-row">
                    <Form.Control
                        type="text"
                        value={inputFieldValue}
                        placeholder={inputFieldPlaceholder}
                        disabled={!dropdownValue}
                        onChange={e => handleInputFieldUpdated(e.target.value)}
                    />
                </Form.Group>
            </div>
        );
    };

    const dropdownsRow = ({
        label,
        primaryControlId,
        secondaryControlId,
        primaryDropdownOptions,
        secondaryDropdownOptions,
        primaryDropdownPlaceholder,
        secondaryDropdownPlaceholder,
        primaryDropdownValue,
        secondaryDropdownValue,
        handlePrimaryDropdownSelected,
        handleSecondaryDropdownSelected
    }) => {
        return (
            <div className="add-test-plan-queue-modal-row">
                <Form.Group controlId={primaryControlId}>
                    <Form.Label>{label}</Form.Label>
                    <Form.Control
                        as="select"
                        onChange={e =>
                            handlePrimaryDropdownSelected(e.target.value)
                        }
                        value={primaryDropdownValue}
                    >
                        <option disabled value={''}>
                            {primaryDropdownPlaceholder}
                        </option>
                        {primaryDropdownOptions.map(item => (
                            <option
                                key={`${item.title ||
                                    item.testPlan.directory}-${item.id}`}
                                value={item.id}
                            >
                                {item.title || `"${item.testPlan.directory}"`}
                            </option>
                        ))}
                    </Form.Control>
                </Form.Group>
                <Form.Group
                    controlId={secondaryControlId}
                    className="add-test-plan-queue-modal-normalize-row"
                >
                    <Form.Control
                        as="select"
                        onChange={e =>
                            handleSecondaryDropdownSelected(e.target.value)
                        }
                        value={secondaryDropdownValue}
                    >
                        <option disabled value={''}>
                            {secondaryDropdownPlaceholder}
                        </option>
                        {secondaryDropdownOptions.map(item => (
                            <option
                                key={`${item.gitSha}-${item.id}`}
                                value={item.id}
                            >
                                {gitUpdatedDateToString(item.updatedAt)}{' '}
                                {item.gitMessage} ({item.gitSha.substring(0, 7)}
                                )
                            </option>
                        ))}
                    </Form.Control>
                </Form.Group>
            </div>
        );
    };

    return (
        <Modal
            show={show}
            onHide={handleClose}
            aria-labelledby="add-test-plan-to-queue-modal"
        >
            <Modal.Header closeButton>
                <Modal.Title>Add a Test Plan to the Test Queue</Modal.Title>
            </Modal.Header>
            <Modal.Body>
                <div className="add-test-plan-queue-modal-container">
                    {dropdownRowWithInputField({
                        label: 'Select an AT and Version',
                        controlId: 'select-at',
                        dropdownOptions: ats,
                        dropdownPlaceholder: 'Assistive Technology',
                        inputFieldPlaceholder: 'AT Version',
                        dropdownValue: selectedAt,
                        inputFieldValue: atVersion,
                        handleDropdownSelected: setSelectedAt,
                        handleInputFieldUpdated: setAtVersion
                    })}

                    {dropdownRowWithInputField({
                        label: 'Select a Browser and Version',
                        controlId: 'select-browser',
                        dropdownOptions: browsers,
                        dropdownPlaceholder: 'Browser',
                        inputFieldPlaceholder: 'Browser Version',
                        dropdownValue: selectedBrowser,
                        inputFieldValue: browserVersion,
                        handleDropdownSelected: setSelectedBrowser,
                        handleInputFieldUpdated: setBrowserVersion
                    })}

                    {dropdownsRow({
                        label: 'Select a Test Plan and Version',
                        primaryControlId: 'select-test-plan',
                        secondaryControlId: 'select-test-plan-version',
                        primaryDropdownOptions: filteredTestPlanVersions,
                        secondaryDropdownOptions: testPlanVersions,
                        primaryDropdownPlaceholder: 'Select Test Plan',
                        secondaryDropdownPlaceholder: 'Select Version',
                        primaryDropdownValue: selectedTestPlan,
                        secondaryDropdownValue: selectedTestPlanVersion,
                        handlePrimaryDropdownSelected: value => {
                            // update test plan versions based on selected test plan
                            const retrievedTestPlan = allTestPlanVersions.find(
                                testPlanVersion => testPlanVersion.id == value
                            );
                            const testPlanVersions = allTestPlanVersions.filter(
                                testPlanVersion =>
                                    testPlanVersion.title ==
                                        retrievedTestPlan.title &&
                                    testPlanVersion.testPlan.directory ==
                                        retrievedTestPlan.testPlan.directory
                            );
                            setTestPlanVersions(testPlanVersions);
                            setSelectedTestPlanVersion('');
                            setSelectedTestPlan(value);
                        },
                        handleSecondaryDropdownSelected: setSelectedTestPlanVersion
                    })}
                </div>
            </Modal.Body>
            <Modal.Footer>
                <Button variant="secondary" onClick={handleClose}>
                    Close
                </Button>
                <Button
                    variant="primary"
                    onClick={async () => {
                        await handleCreateTestPlanReport();
                        await handleClose();
                    }}
                    disabled={
                        !(
                            selectedTestPlanVersion &&
                            selectedAt &&
                            atVersion &&
                            selectedBrowser &&
                            browserVersion
                        )
                    }
                >
                    Add
                </Button>
            </Modal.Footer>
        </Modal>
    );
};

NewTestPlanReportModal.propTypes = {
    show: PropTypes.bool,
    handleClose: PropTypes.func,
    handleAddToTestQueue: PropTypes.func
};

export default NewTestPlanReportModal;
